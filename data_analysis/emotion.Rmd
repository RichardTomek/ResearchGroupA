---
title: "emotion"
output: html_document
---

```{r include=FALSE}
source("helper-scripts/helper.R")

# Define your packages in a vector
required_packages <- c("tidyverse", "ggplot2", "nnet", "stats", "ordinal", "lme4", "broom.mixed", "car", "brms", "corrplot", "performance", "reshape2", "lmerTest")


# Call the function with your package vector
load_packages(required_packages)
```

```{r}

# summarized_data <- combined_data %>%
#   group_by(session_label, task, round_number) %>%
#   summarize(avg_hr = mean(heart_rate)) %>%
#   # slice(1) %>%
#   select(session_label, task, round_number, shape_cluster, feature_cluster, avg_hr) 
# # %>%
#   # ungroup()

summarized_data <- combined_data %>%
  group_by(session_label, task, round_number) %>%
  summarize(
    avg_hr = mean(heart_rate),
    shape_cluster = first(shape_cluster),
    feature_cluster = first(feature_cluster)
  )

```

```{r}
emotion_response <- read_csv(here("data/emotion_responses_lab_run_18_12.csv"))

emotion_response <- emotion_response %>%
  mutate(session_label = paste(session_code, label, sep = "_")) 
```

```{r}
control_variables <- read_csv("data/control_variables_lab_run_18_12.csv")

control_variables <- control_variables %>%
  mutate(session_label = paste(session, label, sep = "_")) 

# First, prepare the control variables with proper types
control_variables <- control_variables %>%
  mutate(
    # Convert categorical variables to factors with explicit levels
    gender = factor(gender),
    age = factor(age),
    consumed_substances = factor(consumed_substances),
    heavy_meal = factor(heavy_meal),
    exercise = factor(exercise),
    
    # Scale continuous enjoyment variables (1-9 scales)
    # Scaling helps with model interpretation and convergence
    math_enjoyment_scaled = scale(math_enjoyment),
    ball_task_enjoyment_scaled = scale(ball_task_enjoyment)
  )

# Join the data
model_data <- summarized_data %>%
  left_join(control_variables, 
            by = "session_label")


data.frame(
  gender_levels = nlevels(factor(model_data$gender)),
  age_levels = nlevels(factor(model_data$age)),
  substances_levels = nlevels(factor(model_data$consumed_substances)),
  meal_levels = nlevels(factor(model_data$heavy_meal)),
  exercise_levels = nlevels(factor(model_data$exercise))
) %>% print()

# Also check the actual levels
cat("\nActual levels:\n")
cat("Gender:", levels(factor(model_data$gender)), "\n")
cat("Age:", levels(factor(model_data$age)), "\n")
cat("Substances:", levels(factor(model_data$consumed_substances)), "\n")
cat("Heavy meal:", levels(factor(model_data$heavy_meal)), "\n")
cat("Exercise:", levels(factor(model_data$exercise)), "\n")
```


# H01

```{r}
# For shape clusters
model_h1_shape <- multinom(shape_cluster ~ 
                          task + 
                          gender +
                          age +
                          consumed_substances +
                          exercise +
                          math_enjoyment_scaled +
                          ball_task_enjoyment_scaled,
                          data = model_data)
summary(model_h1_shape)



# For feature clusters
model_h1_feature <- multinom(feature_cluster ~ 
                          task + 
                          gender +
                          age +
                          consumed_substances +
                          exercise +
                          math_enjoyment_scaled +
                          ball_task_enjoyment_scaled,
                          data = model_data)
summary(model_h1_feature)

Anova(model_h1_shape, type = "III")
Anova(model_h1_feature, type = "III")
```




# H02.2
```{r}
model_data$shape_cluster_binary <- model_data$shape_cluster - 1
model_data$feature_cluster_binary <- model_data$feature_cluster - 1

math_data <- subset(model_data, task == "math")
ball_data <- subset(model_data, task == "ball")

# # For math task
# model_h02_math_shape <- glmer(shape_cluster_binary ~ 
#                         (1 | session_label) +  # Random intercept for participants
#                         gender +
#                         age +
#                         consumed_substances +
#                         exercise +
#                         math_enjoyment_scaled,
#                         family = binomial,
#                         data = math_data)
# 
# # For ball task
# model_h02_ball_shape <- glmer(shape_cluster_binary ~ 
#                         (1 | session_label) +  # Random intercept for participants
#                         gender +
#                         age +
#                         consumed_substances +
#                         exercise +
#                         ball_task_enjoyment_scaled,
#                         family = binomial,
#                         data = ball_data)
# 
# summary(model_h02_math_shape)
# summary(model_h02_ball_shape)
# 
# model_h02_math_feature <- glmer(feature_cluster_binary ~ 
#                         (1 | session_label) +  # Random intercept for participants
#                         gender +
#                         age +
#                         consumed_substances +
#                         exercise +
#                         math_enjoyment_scaled,
#                         family = binomial,
#                         data = math_data)
# 
# # For ball task
# model_h02_ball_feature <- glmer(feature_cluster_binary ~ 
#                         (1 | session_label) +  # Random intercept for participants
#                         gender +
#                         age +
#                         consumed_substances +
#                         exercise +
#                         ball_task_enjoyment_scaled,
#                         family = binomial,
#                         control = glmerControl(optimizer = "bobyqa"),
#                         data = ball_data)
# 
# summary(model_h02_math_feature)
# summary(model_h02_ball_feature)



model_h02_ball_bayes_shape <- brm(
  shape_cluster_binary ~ (1 | session_label) +
    gender + age  + 
    exercise + ball_task_enjoyment_scaled,
  family = bernoulli(),
  data = ball_data,
  control = list(adapt_delta = 0.9),
  cores = 16,  # For faster computation
  iter = 10000 # Increase iterations for stability
)

model_h02_math_bayes_shape <- brm(
  shape_cluster_binary ~ (1 | session_label) +
    gender + age  + 
    exercise + ball_task_enjoyment_scaled,
  family = bernoulli(),
  data = math_data,
  control = list(adapt_delta = 0.9),
  cores = 16,  # For faster computation
  iter = 10000 # Increase iterations for stability
)

model_h02_ball_bayes_feature <- brm(
  feature_cluster_binary ~ (1 | session_label) +
    gender + age  + 
    exercise + ball_task_enjoyment_scaled,
  family = bernoulli(),
  data = ball_data,
  cores = 16,  # For faster computation
  iter = 10000
)

model_h02_math_bayes_feature <- brm(
  feature_cluster_binary ~ (1 | session_label) +
    gender + age  + 
    exercise + ball_task_enjoyment_scaled,
  family = bernoulli(),
  data = math_data,
  cores = 16,  # For faster computation
  iter = 10000 # Increase iterations for stability
)

summary(model_h02_ball_bayes_shape)
summary(model_h02_math_bayes_shape)
summary(model_h02_ball_bayes_feature)
summary(model_h02_math_bayes_feature)
```



# H03

```{r}
emotion_response$round_number <- emotion_response$round
merged_data <- merge(model_data, emotion_response, 
                    by=c("session_label", "task", "round_number"))
```


```{r}
# Create correlation matrix for emotional variables
emotion_vars <- merged_data[, c("anger", "disgust", "fear", "anxiety", 
                               "sadness", "happiness", "desire", "relaxation",
                               "excitement_sam", "happiness_sam")]
cor_matrix <- cor(emotion_vars)

# Visualize correlation matrix
corrplot(cor_matrix, method = "color", type = "upper", 
         addCoef.col = "black", number.cex = 0.7)

# Calculate VIF for emotional variables in basic model
model_vif <- lm(scale(anger) ~ ., data = emotion_vars)
vif_values <- vif(model_vif)
print(vif_values)

# If needed, we can use PCA to reduce dimensionality
emotion_pca <- prcomp(emotion_vars, scale. = TRUE)
summary(emotion_pca)

# Extract principal components explaining >80% of variance
pcs <- predict(emotion_pca)[, 1:3]  # Adjust number based on results
merged_data$emotion_pc1 <- pcs[,1]
merged_data$emotion_pc2 <- pcs[,2]
merged_data$emotion_pc3 <- pcs[,3]
```




```{r}
# Ensure clusters are factors
merged_data$shape_cluster <- as.factor(merged_data$shape_cluster)
merged_data$feature_cluster <- as.factor(merged_data$feature_cluster)

# 1. Shape cluster model with emotional variables
shape_model1_mixed <- glmer(shape_cluster ~ 
    scale(anger) + scale(disgust) + scale(fear) + scale(anxiety) + 
    scale(sadness) + scale(happiness) + scale(desire) + scale(relaxation) +
    gender + age + exercise + 
    math_enjoyment_scaled + ball_task_enjoyment_scaled +
    scale(round_number) + task +
    (1|session_label),
    data = merged_data,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa",
                          optCtrl = list(maxfun = 100000)))

# 2. Shape cluster model with SAM variables
shape_model2_mixed <- glmer(shape_cluster ~ 
    scale(excitement_sam) + scale(happiness_sam) +
    gender + age + exercise + 
    math_enjoyment_scaled + ball_task_enjoyment_scaled +
    scale(round_number) + task +
    (1|session_label),
    data = merged_data,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa",
                          optCtrl = list(maxfun = 100000)))

# 3. Feature cluster model with emotional variables
feature_model1_mixed <- glmer(feature_cluster ~ 
    scale(anger) + scale(disgust) + scale(fear) + scale(anxiety) + 
    scale(sadness) + scale(happiness) + scale(desire) + scale(relaxation) +
    gender + age + exercise + 
    math_enjoyment_scaled + ball_task_enjoyment_scaled +
    scale(round_number) + task +
    (1|session_label),
    data = merged_data,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa",
                          optCtrl = list(maxfun = 100000)))

# 4. Feature cluster model with SAM variables
feature_model2_mixed <- glmer(feature_cluster ~ 
    scale(excitement_sam) + scale(happiness_sam) +
    gender + age + exercise + 
    math_enjoyment_scaled + ball_task_enjoyment_scaled +
    scale(round_number) + task +
    (1|session_label),
    data = merged_data,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa",
                          optCtrl = list(maxfun = 100000)))




summary(glmer(task == "math" ~ 
    scale(excitement_sam) + scale(happiness_sam) +
    gender + age + exercise + 
    math_enjoyment_scaled + ball_task_enjoyment_scaled +
    scale(round_number) +
    (1|session_label),
    data = merged_data,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa",
                          optCtrl = list(maxfun = 100000))))


summary(glmer(task == "math" ~ 
    scale(anger) + scale(disgust) + scale(fear) + scale(anxiety) + 
    scale(sadness) + scale(happiness) + scale(desire) + scale(relaxation) +
    gender + age + exercise + 
    math_enjoyment_scaled + ball_task_enjoyment_scaled +
    scale(round_number) + 
    (1|session_label),
    data = merged_data,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa",
                          optCtrl = list(maxfun = 100000))))

# To get summaries:
summary(shape_model1_mixed)
summary(shape_model2_mixed)
summary(feature_model1_mixed)
summary(feature_model2_mixed)


```


```{r}
# Model for shape clusters
multinom(shape_cluster ~ anger + disgust + fear + anxiety + 
                          sadness + happiness + desire + relaxation + 
                          round_number + session_label, data = merged_data)
print("")
print("")
print("")

multinom(shape_cluster ~ excitement_sam + happiness_sam + 
                          round_number + session_label, data = merged_data)

print("")
print("")
print("")


# Model for feature clusters
summary(multinom(feature_cluster ~ anger + disgust + fear + anxiety + 
                            sadness + happiness + desire + relaxation + 
                          round_number + session_label, data = merged_data))

print("")
print("")
print("")


multinom(feature_cluster ~ excitement_sam + happiness_sam + 
                          round_number + session_label, data = merged_data)

print("")
print("")
print("")

# Logistic regression (task as dependent variable)
glm(task == "math" ~ anger + disgust + fear + anxiety + 
                     sadness + happiness + desire + relaxation + 
                          round_number + session_label,
                     family = binomial, data = merged_data)

print("")
print("")
print("")

glm(task == "math" ~  excitement_sam + happiness_sam + 
                          round_number + session_label, 
                     family = binomial, data = merged_data)
```

#H04

```{r}
# Fit the model
model <- lmer(avg_hr ~ round_number * task + 
              gender + age + exercise +
              math_enjoyment_scaled + ball_task_enjoyment_scaled + 
              (round_number | participant_id.x), 
              data = merged_data)

# Get summary with p-values
summary(model)

# For null model comparison
null_model <- lmer(avg_hr ~ round_number + task + 
                   gender + age + exercise +
                   math_enjoyment_scaled + ball_task_enjoyment_scaled + 
                   (round_number | participant_id.x), 
                   data = merged_data)

# Compare models
anova(null_model, model)


# 
# clmm(as.ordered(shape_cluster) ~ round_number + (1|session_label), 
#      data = ball_data)
# clmm(as.ordered(feature_cluster) ~ round_number + (1|session_label), 
#      data = math_data)

```

Ball Task:

Shape Clusters over rounds:

χ² = 5.5502, p = 0.2353 (not significant)
No significant change in heart rate shape patterns across rounds


Feature Clusters over rounds:

χ² = 1.0752, p = 0.8982 (not significant)
No significant change in heart rate features across rounds



Math Task:

Shape Clusters over rounds:

χ² = 6.1943, p = 0.1851 (not significant)
No significant change in heart rate shape patterns across rounds


Feature Clusters over rounds:

χ² = 0.6889, p = 0.9527 (not significant)
No significant change in heart rate features across rounds



Overall interpretation:

We fail to reject H04 for all tests
There's no evidence that participants' heart rate patterns (either shapes or features) change significantly as they repeat either task
This suggests:

Physiological responses remain relatively stable across repeated tasks
No significant habituation effect was detected
The stress/enjoyment response doesn't seem to diminish with repetition


```{r}
glm(avg_hr ~ round_number, data = summarized_data)

lmer(avg_hr ~ round_number * task +
     (1 | session_label), 
     data = summarized_data)
```

